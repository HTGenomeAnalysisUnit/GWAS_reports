# GWAS report

Quarto templates to generate reports from summary stats of GWAS or rare variant analysis.

The report uses the [gwaslab package](https://github.com/Cloufield/gwaslab/) to generate plots. 

## Dependency

You need [Quarto](https://quarto.org/) and [Papermill](https://papermill.readthedocs.io/en/latest/) installed on your system to render the report and `tabix` command must be available to generate the regional plots quickly.

The report templates depends on the following packages:
- python <3.10 
- matplotlib==3.5.0 
- mscorefonts 
- skimpy 
- gwaslab==3.4.19
- papermill

We provide a docker image pre-packed with all necessary dependencies at `edg1983/gwas-rmd-reports:v2.0`.
 
## Quick start

With the following command you can generate a `gwas_report_template.html` report from a summary stats file, a phenotype file and a tophits table:

```bash
quarto render gwas_report_template.qmd \
	-P project:"myproject_title" \
	-P sumstat_file:"mysumstats.tsv" \
	-P annotated_toploci_filename:"toploci.tsv" \
	-P phenotype_file:"phenotypes.tsv" \
	-P phenotype:"mypheno" \
	-P genome_build: "hg19" \
	--to html
```

The rare variants report at the moment only works for regenie rare variant test(s) output. You can generate an HTML report with a command like this:

```bash
quarto render rare_variants_report_template.qmd \
	-P project:"myproject_title" \
	-P sumstat_file:"mysumstats.tsv" \
	-P phenotype_file:"phenotypes.tsv" \
	-P phenotype:"mypheno" \
	-P genome_build: "hg19" \
	--to html
```


## GWAS report

See the example report `example_gwas_report.html` in examples folder.

The minimum required input is a summary stats file in one of the format supported by the [gwaslab package](https://github.com/Cloufield/formatbook) and the corresponding phenotype file. Both are expected to be tab-separated.

Additionally, you can provide a tophits table that identify top SNPs with overlapping genes annotations. This is a tab-separated file with header and the following columns: 'CHROM','GENPOS','SNPID','LOG10P','CLOSEST_GENE_NAME'.

Finally, the report can take a toploci file describing loci clumped from the summary stats. This is expected to be in the format generated by [plink --clump](https://www.cog-genomics.org/plink/1.9/postproc#clump). An header line must be present and minimum required columns are: 'CHR', 'POS', 'SNP'.

Starting from the same input files, the script `make_hq_plots.py` can be used to generate high-quality stand-alone PNG images of for the Manhattan plot and regional plots. See `make_hq_plots.py -h` for more details.

### Parameters

- project: report title
- date: date
- version: version for the analysis
- sumstat_file: summary stats file
- phenotype: phenotype name
- covariates: covariates names
- phenotype_file: tab-separated file containing the phenotype data
- manhattan_annotation_type: how to annotate manhattan plot. Can be "genes" when a tophits table is provided or "rsid" when no tophits table is provided.
- annotation_min_log10p: an additional line is added to the manhattan plot at this value
- annotated_tophits_filename: annotated top hits table
- annotated_toploci_filename: top loci table
- max_loci: number of top loci to plot
- regional_plot_window_kb: kb to expand around each locus in regional plots
- genome_build: genome build. Can be hg19 or hg38
- sumstat_format: format of the summary stats file (see above)

## Rare variants report

The rare variants report at the moment only works for regenie rare variant test(s) output. 

The minimum required input is a summary stats file from rare variants analysis performed with [regenie](https://github.com/rgcgithub/regenie) and the corresponding phenotype file. Both are expected to be tab-separated.

Within the report we compute FDR and Bonferroni corrected P values across all performed test, and also by group of tests (namely each combination of mask, test and AF bin).

You can generate a table with the above annotations starting from the regenie results using the script `process_regenie_rarevar.py`. 

```bash
process_regenie_rarevar.py regenie_results.tsv[.gz]
```

This will generate a new table named `regenie_results.tsv.correctedP.gz`

### Parameters

- project: report title
- date: date
- version: version for the analysis
- sumstat_file: summary stats file
- phenotype: phenotype name
- covariates: covariates names
- phenotype_file: tab-separated file containing the phenotype data
- genome_build: genome build. Can be hg19 or hg38
- tophits_min_value: a threshold on LOG10P to annotate top hits in the general manhattan plot
- sig_value_threshold: the threshold on the selected stat. Results where the stat test value is above this threshold will be annotated in the manhattan plot
- significance_stat_test: the corrected P value for additional plot. Can be ["BONF_bygroup", "BONF_alltests", "FDR_bygroup", "FDR_alltests"]

## Logs files

The following parameters can be used in both rare variants and gwas report to load tables generated from the log files of regenie step1 and step2 and the processing of covariates and phenotypes input files. They can be omitted.

- regenie_step1_log
- regenie_step2_log
- phenotype_log
- covariate_log